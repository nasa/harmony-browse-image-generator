#!/bin/bash
###############################################################################
#
# Pushes the latest version of the sds/harmony-browse-image-generator image to
# an AWS ECR repository. This script requires AWS credentials to be set.
#
# This script can be called with an optional parameter denoting the tag to
# associate with the Docker image. The Bamboo build plan should use the
# semantic version number saved in `docker/service_version.txt`. This script
# will default to use "latest" if no tag is supplied as an argument.
#
# 2020-05-07: Adapted from SwotRepr.
# 2023-04-04: Update for the Harmony Browse Image Generator (HyBIG).
#
###############################################################################
set -ex

image="sds/harmony-browse-image-generator"

# This tag should be supplied by Bamboo during deployment. If not, it will
# default to "latest".
#
tag=${1:-latest}

region=${AWS_DEFAULT_REGION-"us-west-2"}

account=$(aws sts get-caller-identity --output text --query 'Account')
# Need to remove \r returned on all aws commands run from Bamboo
account=${account//$'\r'/}

login_command=$(aws ecr get-login --no-include-email --region ${region})
# Need to remove \r returned on all aws commands run from Bamboo
login_command=${login_command//$'\r'/}
$login_command

docker tag ${image}:${tag} ${account}.dkr.ecr.${region}.amazonaws.com/${image}:${tag}

# Create ECR repo if it doesn't exist
aws ecr describe-repositories --repository-names ${image} || aws ecr create-repository --repository-name ${image}

docker push ${account}.dkr.ecr.${region}.amazonaws.com/${image}:${tag}
